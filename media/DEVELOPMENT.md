# Development Guide - mochila-ts

Detailed development documentation for contributors and maintainers.

## Architecture Overview

### Core Philosophy

**Data-Last Pattern**: Functions take configuration/predicate first, data last
```typescript
// Configuration FIRST, data LAST
export const filter =
  <V>(fn: (x: V) => boolean) =>     // Step 1: Predicate
  <T extends V>(source: ReadonlyArray<T>) =>  // Step 2: Data
    source.filter(fn) as T[];

// Usage: filter(isEven)([1,2,3,4,5]) ✓
```

Benefits:
- Easy composition with `pipe()` and function composition
- Partial application for functional programming
- Clear intent: predicate/config determines behavior

### Module Structure

Each utility has this structure:
```
src/{utilityName}/
├── {utilityName}.ts      # Implementation (data-last curried function)
├── {utilityName}.test.ts # Unit tests (85%+ coverage required)
└── index.ts              # Exports
```

Module exports can use either pattern:
- `export * from './{utilityName}'` - Export all
- `export { name } from './{utilityName}'` - Named exports only

### Type Organization

Shared types in `src/types/`:
- `function.ts` - Function utilities (AnyFn, Constant)
- `helpers.ts` - Type helpers
- `array/`, `string.ts`, `number.ts`, `boolean.ts`, `object.ts` - Domain-specific types
- `extends.ts` - Type constraint utilities

## Development Workflow

### Adding a New Utility

1. **Create directory structure:**
   ```bash
   mkdir -p src/{utilityName}
   ```

2. **Implement function** (`{utilityName}.ts`):
   ```typescript
   /**
    * Brief description.
    *
    * @category Array
    * @example
    * ```
    * filter(isEven)([1,2,3,4,5]) // [2, 4]
    * ```
    *
    * @param predicate - Function to filter by
    * @param source - Array to filter
    * @returns Filtered array
    */
   export const filter = <V>(fn: (x: V) => boolean) =>
     <T extends V>(source: ReadonlyArray<T>) => source.filter(fn) as T[];
   ```

3. **Create tests** (`{utilityName}.test.ts`):
   ```typescript
   describe('filter', () => {
     test('must filter array elements', () => {
       expect(filter((x) => x > 2)([1, 2, 3, 4])).toEqual([3, 4]);
     });
   });
   ```
   Target: 85%+ coverage (lines, functions, statements)

4. **Export from index:**
   ```typescript
   // src/{utilityName}/index.ts
   export * from './{utilityName}';
   ```

5. **Add to main exports:**
   ```typescript
   // src/index.ts (keep alphabetical)
   export * from './{utilityName}';
   ```

6. **Verify:**
   ```bash
   pnpm test
   pnpm lint
   pnpm build
   ```

### Modifying Existing Utilities

1. Update implementation
2. Update tests (maintain 85%+ coverage)
3. Update JSDoc if behavior changed
4. Run `pnpm test` and `pnpm lint`
5. Commit with conventional message (feat:, fix:, etc.)

### Fixing Bugs

1. Write test that reproduces bug
2. Fix implementation
3. Ensure all tests pass and coverage maintained
4. Commit as `fix: description`

## Code Quality Standards

### TypeScript

- **Strict mode required** (configured in tsconfig.json)
- **No explicit `any`** (use generics or `unknown` instead)
- **Imports sorted alphabetically** (ESLint enforces via simple-import-sort)
- **Type inference** must work correctly in generic functions

### Testing

- **Coverage minimum:** 85% (lines, functions, statements), 50% (branches)
- **Test pattern:** Describe functionality, use clear assertions
- **Run before commit:** `pnpm test:coverage`
- **Edge cases:** Test boundary conditions, null/undefined, type narrowing

### Code Style

- **Formatter:** Prettier (2-space indentation, single quotes, trailing commas)
- **Linter:** ESLint with @typescript-eslint, simple-import-sort, tsdoc
- **Pre-commit:** Auto-formats staged files (lint-staged + husky)
- **Check command:** `pnpm lint`

### Documentation

- **JSDoc required** for all exports
- **Required tags:**
  - `@category` - Feature area (Array, String, Function, Guard, etc.)
  - `@example` - Usage showing data-last pattern
  - `@param` - Parameter descriptions
  - `@typeParam` - Generic type parameters
  - `@returns` - Return value description
- **Generated by:** TypeDoc (see `typedoc.json`)

## Build & Testing

### Scripts

```bash
pnpm build              # Build (ESM + CJS + .d.ts)
pnpm dev                # Watch mode
pnpm test               # Run all tests
pnpm test:watch         # Watch mode
pnpm test:coverage      # Coverage report
pnpm lint               # ESLint + Prettier check
pnpm type-check         # Type coverage (target: 95%)
pnpm size               # Bundle size check (limit: 30 kB)
pnpm doc                # Generate TypeDoc
```

### Build Process

**tsup** outputs three formats:
- **ESM** (`.mjs`) - Modern ES modules
- **CJS** (`.js`) - CommonJS for older Node versions
- **DTS** (`.d.ts`, `.d.mts`) - TypeScript type definitions

All outputs go to `dist/` with source maps.

### Testing

- **Framework:** Jest
- **Coverage thresholds:** 85% (lines/functions/statements), 50% (branches)
- **Test files:** `src/**/*.test.ts`
- **Run before commit:** `pnpm test:coverage`

## Pre-Commit Hooks

Configured via husky + lint-staged:

1. **Pre-commit hook** (`.husky/pre-commit`):
   - Runs ESLint fix and Prettier write on staged TypeScript files
   - Prevents committing unformatted code

2. **Commit-msg hook** (`.husky/commit-msg`):
   - Validates commit message format (conventional commits)
   - Integrated with semantic-release for automated versioning

**Conventional Commit Types:**
- `feat:` - New feature
- `fix:` - Bug fix
- `docs:` - Documentation
- `style:` - Code style (formatting)
- `refactor:` - Code refactoring
- `perf:` - Performance improvement
- `test:` - Test additions/changes
- `chore:` - Build, dependencies, tooling

## Release Process

Automated via GitHub Actions:

1. **Trigger:** Push to `main` branch
2. **Steps:**
   - Run tests (must pass)
   - Build (must succeed)
   - Run semantic-release (auto-determines version bump)
   - Create GitHub release
   - Publish to npm (with provenance attestation)
   - Deploy docs to GitHub Pages

**Version Bumping:**
- `feat:` → MINOR version bump
- `fix:` → PATCH version bump
- `BREAKING CHANGE:` → MAJOR version bump

See `release.config.cjs` for configuration.

## Configuration Files

| File | Purpose |
|------|---------|
| `tsconfig.json` | TypeScript strict mode (ES2020, Bundler resolution) |
| `tsup.config.ts` | Build configuration |
| `jest.config.js` | Test framework (85% coverage thresholds) |
| `.eslintrc.js` | Linting rules (@typescript-eslint, prettier, tsdoc) |
| `.prettierrc.json` | Formatting (2-space, single quotes, trailing commas) |
| `package.json` | Scripts, exports, engines (Node >=20, pnpm >=9) |
| `commitlint.config.cjs` | Commit message validation |
| `.pnpmrc` | Strict dependency management |
| `.size-limit.js` | Bundle size limits |

## Troubleshooting

**Build fails with type errors:**
- Check `tsconfig.json` strict mode enabled
- Avoid explicit `any` types
- Ensure generics properly constrained

**Tests fail coverage:**
- Add test cases for uncovered branches
- Check coverage report: `pnpm test:coverage`

**Lint errors:**
- Auto-fix: `pnpm exec eslint --fix src/`
- Format: `pnpm exec prettier --write src/`

**Type errors in generics:**
- Ensure proper type inference in function signatures
- Use `extends` constraints appropriately
- Test with different type combinations

**Commit rejected:**
- Message must follow conventional format
- Example: `feat: add new utility function`

## Performance & Optimization

**Bundle size:**
- Target: <30 kB (ESM + CJS)
- Current: 2.53 kB ESM, 3.4 kB CJS
- Monitor with: `pnpm size`

**Type coverage:**
- Target: >95%
- Current: 99.75%
- Check with: `pnpm type-check`

**Runtime:**
- All utilities are lightweight wrappers
- Zero dependencies (by design)
- Leverage TypeScript's type system for optimization

## Resources

- [README.md](./README.md) - Project overview
- [AGENTS.md](./AGENTS.md) - Quick reference for AI tools
- [TypeDoc API](https://jmlweb.github.io/mochila/modules.html) - Full API docs
- [GitHub Repo](https://github.com/jmlweb/mochila) - Source code
